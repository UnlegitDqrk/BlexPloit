package de.blexploit.inventory.items.TROLL;

import java.util.ArrayList;
import java.util.Random;

import org.bukkit.Location;
import org.bukkit.Material;
import org.bukkit.entity.EntityType;
import org.bukkit.entity.Snowball;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.entity.ProjectileHitEvent;
import org.bukkit.util.Vector;

import api.ParticleEffect;
import de.blexploit.inventory.creator.Bereich;
import de.blexploit.inventory.creator.InvItem;
import de.blexploit.players.create.MittrollerEntity;

public final class Flummi extends InvItem implements Listener {
	private ArrayList<Snowball> flummies = new ArrayList<Snowball>();
	private Random rnd = new Random();

	public Flummi() {
		super("Flummi", "(R)Ein paar nervige Flummies gefällig?;§2(L)Lässt sie wieder verschwinden",
				Material.SLIME_BALL, 0, Bereich.TROLLING, false);
	}

	@Override
	public void right_click(MittrollerEntity mt) {
		this.spielerInfo(mt, "hat sine Flummies verloren.");
		flummies.clear();
		Location loc = api.Get.targetLoc(mt.getPlayer());
		for (int i = 0; i < 30; i++) {
			Snowball sb = spawnsb(loc);
			sb.setVelocity(new Vector(rnd.nextDouble() - 0.5, rnd.nextDouble() + 1, rnd.nextDouble() - 0.5));
			flummies.add(sb);
		}
	}

	@Override
	public void left_click(MittrollerEntity mt) {
		flummies.clear();
		this.spielerInfo(mt, "findet hüpfen nicht hip!");
	}

	private long latest_spawn = 0;

	private Snowball spawnsb(Location loc) {
		Snowball sb = (Snowball) loc.getWorld().spawnEntity(loc.add(0, 1.5, 0), EntityType.SNOWBALL);
		ParticleEffect.FLAME.display(0.2F, 0.2F, 0.2F, 1, 20, loc, 999);
		flummies.add(sb);
		return sb;
	}

	@EventHandler
	private void onSnowballHit(ProjectileHitEvent e) {
		if (e.getEntity().getType() == EntityType.SNOWBALL) {
			if (!flummies.contains(e.getEntity())) {
				return;
			}
			long minimum = latest_spawn + 10;
			if (System.currentTimeMillis() >= minimum) {
				latest_spawn = System.currentTimeMillis();
				Location loc = e.getEntity().getLocation();
				if (flummies.size() > 2000) {
					Snowball sb = spawnsb(loc.add(0, 1.5, 0));
					sb.setVelocity(new Vector(rnd.nextDouble() - 0.5, rnd.nextDouble() + 1, rnd.nextDouble() - 0.5));
				} else {
					for (int i = 0; i < 4; i++) {
						Snowball sb = spawnsb(loc);
						sb.setVelocity(
								new Vector(rnd.nextDouble() - 0.5, rnd.nextDouble() + 1, rnd.nextDouble() - 0.5));
					}
				}
				flummies.remove(e.getEntity());
			}
		}
	}

}
