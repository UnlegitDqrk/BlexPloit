package de.blexploit.inventory.items.GRIEF;

import java.util.ArrayList;

import org.bukkit.Location;
import org.bukkit.Material;
import org.bukkit.entity.FallingBlock;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.entity.EntityChangeBlockEvent;
import org.bukkit.util.Vector;

import de.blexploit.inventory.creator.Bereich;
import de.blexploit.inventory.creator.InvItem;
import de.blexploit.players.create.MittrollerEntity;

public final class Tornado extends InvItem implements Listener {

	public Tornado() {
		super("Tornado", "Eine neue Naturkatastrophe in Minecraft", Material.CARROT_ITEM, 0, Bereich.GRIEFING, false);
	}

	private ArrayList<FallingBlock> FBs = new ArrayList<FallingBlock>();

	@SuppressWarnings("deprecation")
	@Override
	public void right_click(final MittrollerEntity mt) {
		final Location lc = api.Get.targetLoc(mt.getPlayer());
		api.Send.OnlinePlayersSound("ENTITY_BLAZE_SHOOT", lc, 4.6f, 0.6f);
		Location tmp = lc.add(api.Get.rand(-1, 1), 0, api.Get.rand(-1, 1));
		for (double x = lc.getX() - 1; x <= lc.getX() + 1; x++) {
			for (double z = lc.getZ() - 1; z <= lc.getZ() + 1; z++) {
				tmp.setY(tmp.getWorld().getHighestBlockYAt(tmp));
				FallingBlock fb = tmp.getWorld().spawnFallingBlock(new Location(lc.getWorld(), x, tmp.getY(), z),
						Material.WEB.getId(), new Location(lc.getWorld(), x, tmp.getY() - 1, z).getBlock().getData());
				fb.setVelocity(new Vector(0, 2, 0));
				while (FBs.size() > 200) {
					FBs.get(0).remove();
					FBs.remove(0);
				}
				FBs.add(fb);
				int id = new Location(lc.getWorld(), x, tmp.getY() - 1, z).getBlock().getTypeId();
				byte data = new Location(lc.getWorld(), x, tmp.getY() - 1, z).getBlock().getData();

				new Location(lc.getWorld(), x, tmp.getY() - 1, z).getBlock().setType(Material.AIR);
				FallingBlock bla = tmp.getWorld().spawnFallingBlock(new Location(lc.getWorld(), x, tmp.getY() + 1, z),
						id, data);
				bla.setVelocity(new Vector(api.Get.rand(-1, 1), api.Get.rand(1, 2), api.Get.rand(-1, 1)));
			}
		}
	}

	@EventHandler
	private void noWeb(EntityChangeBlockEvent e) {
		if (e.getEntity() instanceof FallingBlock) {
			FallingBlock fb = (FallingBlock) e.getEntity();
			if (fb.getMaterial().equals(Material.WEB)) {
				if (FBs.contains(fb)) {
					e.setCancelled(true);
				}
			}
		}
	}

}
