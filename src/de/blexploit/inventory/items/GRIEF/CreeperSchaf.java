package de.blexploit.inventory.items.GRIEF;

import java.util.ArrayList;

import org.bukkit.Bukkit;
import org.bukkit.ChatColor;
import org.bukkit.DyeColor;
import org.bukkit.GameMode;
import org.bukkit.Material;
import org.bukkit.entity.EntityType;
import org.bukkit.entity.Player;
import org.bukkit.entity.Sheep;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.entity.EntityDamageByEntityEvent;
import org.bukkit.plugin.Plugin;

import de.blexploit.Start;
import de.blexploit.inventory.creator.Bereich;
import de.blexploit.inventory.creator.InvItem;
import de.blexploit.players.create.MittrollerEntity;

public final class CreeperSchaf extends InvItem implements Listener{
	private ArrayList<Sheep> creeperSheeps = new ArrayList<>();
	private final Plugin sheep_shedule = Start.instance;
	private boolean farbe = false;
	private ArrayList<Integer> active_shedulers = new ArrayList<>();

	public CreeperSchaf() {
		super("CreeperSchaf", "(R)Erschafft ein explosives Schaf;(L)Entfernt es", Material.COOKED_BEEF, 0,
				Bereich.GRIEFING, false);
	}

	@Override
	public void right_click(MittrollerEntity mt) {
		this.spielerInfo(mt, "sagt: \"Mähhh\"");
		Sheep sheep = (Sheep) mt.getPlayer().getWorld().spawnEntity(api.Get.targetLoc(mt.getPlayer()).add(0, 1, 0),
				EntityType.SHEEP);
		sheep.setCustomName("§4Creeper");
		sheep.setColor(DyeColor.GREEN);
		creeperSheeps.add(sheep);
		api.Godmode.add(sheep);
	}

	@Override
	public void left_click(MittrollerEntity mt) {
		this.spielerInfo(mt, "sagt: \"Mähhh by by määhh\"");
		for (Sheep shep : creeperSheeps) {
			if (shep != null) {
				if (shep.isDead() == false) {
					shep.remove();
				}
			}
		}
		creeperSheeps.clear();
		mt.sendMessage(ChatColor.GOLD + "Alle Schafe wurden entfernt!");
	}

	@EventHandler
	private void sheephit(EntityDamageByEntityEvent e) {
		if (e.getEntity() instanceof Sheep) {
			if (!(e.getDamager() instanceof Player)) {
				return;
			}
			if (creeperSheeps.contains(e.getEntity())) {
				final Sheep Cshep = (Sheep) e.getEntity();
				if (Cshep.getColor() != DyeColor.GREEN) {
					return;
				}
				api.Send.OnlinePlayersSound("ENTITY_CREEPER_PRIMED", Cshep.getLocation(), 1, 1);
				final Player p = (Player) e.getDamager();
				active_shedulers.add(Bukkit.getScheduler().scheduleSyncRepeatingTask(sheep_shedule, new Runnable() {
					@Override
					public void run() {
						if (farbe == false) {
							Cshep.setColor(DyeColor.YELLOW);
							farbe = true;
						} else {
							Cshep.setColor(DyeColor.RED);
							farbe = false;
						}

					}
				}, 0, 1));

				Bukkit.getScheduler().scheduleSyncDelayedTask(sheep_shedule, new Runnable() {
					@Override
					public void run() {
						Cshep.remove();
						p.setGameMode(GameMode.ADVENTURE);
						p.setHealth(1D);
						Cshep.getLocation().getWorld().createExplosion(Cshep.getLocation(), 30);
						creeperSheeps.remove(Cshep);
						api.Godmode.remove(Cshep);
						for (int i : active_shedulers) {
							Bukkit.getScheduler().cancelTask(i);
						}
						active_shedulers.clear();
					}
				}, 30);

			}
		}
	}

}
